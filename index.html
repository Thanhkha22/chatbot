<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hướng nghiệp & chọn ngành học</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #f4f6fa);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    /* Khung chính */
    .chat-container {
      width: 90%;
      max-width: 450px;
      height: 90vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- HEADER --- */
    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #0078ff;
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 17px;
    }

    /* Chat box */
    .chat-box {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f9fbff;
      scroll-behavior: smooth;
    }

    /* Tin nhắn */
    .msg {
      display: flex;
      margin-bottom: 12px;
      align-items: flex-end;
      animation: fadeIn 0.3s ease-in-out;
    }
    .msg.user { justify-content: flex-end; }
    .msg.bot { justify-content: flex-start; }

    .bubble {
      white-space: pre-line;
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 75%;
      line-height: 1.5;
      word-break: break-word;
    }
    .bubble {
     
      font-size: 15px;
    }
    .bubble strong {
      color: #0056d2;
    }

    .msg.user .bubble {
      background: #0078ff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg.bot .bubble {
      background: #eefaf0;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin: 0 6px;
    }

    /* Input box */
    .input-box {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 10px;
      background: #fafafa;
    }

    .input-box input {
      flex: 1;
      border: none;
      outline: none;
      padding: 10px 15px;
      border-radius: 20px;
      background: #f0f2f5;
      font-size: 15px;
    }

    .input-box button {
      margin-left: 8px;
      border: none;
      background: #0078ff;
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s ease;
    }

    .input-box button:hover { background: #005ccc; }

    /* Hiệu ứng gõ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hiệu ứng 3 chấm */
    .typing-dots { display: inline-block; margin-left: 4px; }
    .dot {
      height: 8px;
      width: 8px;
      margin: 0 2px;
      background-color: #888;
      border-radius: 50%;
      display: inline-block;
      animation: blink 1.4s infinite both;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }

    /* Quick reply */
    .quick-reply {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 12px 14px;
      background: linear-gradient(180deg, #f8faff, #eef4ff);
      border-top: 1px solid #dbe2f0;
      justify-content: center;
    }

    .quick-reply button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: white;
      border: 1px solid #c9d8ff;
      color: #0078ff;
      border-radius: 25px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .quick-reply button:hover {
      background: #0078ff;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,120,255,0.25);
    }

    /* Mobile */
    @media (max-width: 600px) {
      .chat-container { width: 100%; height: 100vh; border-radius: 0; }
      .bubble { max-width: 80%; }
      .chat-header { font-size: 16px; padding: 12px; }
      .input-box input { font-size: 14px; }
    }

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed;
  top: 0;
  left: -250px; /* Ẩn ban đầu */
  width: 250px;
  height: 100vh;
  border-radius: 0 12px 12px 0;
  background: linear-gradient(180deg, white, white);
  color: white;
  border-right: 2px solid rgba(255,255,255,0.2);
  box-shadow: 4px 0 10px rgba(0,0,0,0.25);
  transition: left 0.4s ease;
  z-index: 1000;
  padding: 20px;
}

.sidebar.active {
  left: 0;
}
.chat-container {
  transition: transform 0.4s ease;
  position: relative;
  z-index: 5;
}

.chat-container.shifted {
  transform: translateX(250px);
}

/* // */
/* ===== Ô tìm kiếm trong sidebar ===== */
.search-box {
  margin: 15px 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e8eaed;
  border-radius: 20px;
}

.search-box input {
  width: 100%;
  padding: 0px 0px;
  border: none;
  
  background: #e8eaed;
  outline: none;
  font-size: 14px;
  color: #333;
  transition: box-shadow 0.2s ease;
}

.search-box input:focus {
  box-shadow: 0 0 6px rgba(255,255,255,0.6);
}

/* ===== Nút cuộc trò chuyện mới ===== */
.new-chat-btn {
  width: 100%;
  background: white;
  
  border: none;
  border-radius: 25px;
  padding: 10px 0;
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.25s ease;
  
}

.new-chat-btn:hover {
  background: white;
  color: rgb(8, 8, 8);
 box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  transition: background-color 0.25s ease, color 0.25s ease;
}
.span{
  color: black;
  font-weight: 600;
}
/* // */
.chat-item {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f7ff;
  margin: 6px 0;
  padding: 6px 8px;
  border-radius: 8px;
}

.chat-title {
  flex: 1;
  color: #222;
  cursor: pointer;
  font-size: 14px;
}
.menu-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #555;
}
.menu {
  display: none;
  position: absolute;
  right: 10px;
  top: 32px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
}
.menu button {
  display: block;
  width: 100%;
  border: none;
  background: none;
  padding: 8px 12px;
  text-align: left;
  cursor: pointer;
}
.menu button:hover {
  background: #0078ff;
  color: white;
}
.chat-item {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f7ff;
  margin: 6px 0;
  padding: 6px 8px;
  border-radius: 8px;
  transition: background 0.2s ease;
}
.chat-item:hover {
  background: #e8efff;
}
.chat-title {
  flex: 1;
  color: #222;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
}
.menu-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #555;
}
.menu {
  display: none;
  position: absolute;
  right: 10px;
  top: 32px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  z-index: 10;
}
.menu button {
  display: block;
  width: 100%;
  border: none;
  background: none;
  padding: 8px 12px;
  text-align: left;
  cursor: pointer;
}
.menu button:hover {
  background: #0078ff;
  color: white;
}
.pinned {
  border-left: 3px solid #0078ff;
  background: #eef4ff;
}
/* ===== DANH SÁCH CUỘC TRÒ CHUYỆN ===== */
#chatList {
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.chat-item {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f8f9ff;
  border: 1px solid #e2e6f3;
  border-radius: 10px;
  padding: 10px 12px;
  transition: all 0.25s ease;
  cursor: pointer;
}

.chat-item:hover {
  background: #eaf0ff;
  box-shadow: 0 2px 6px rgba(0, 120, 255, 0.1);
  transform: translateY(-1px);
}

.chat-title {
  flex: 1;
  color: #222;
  font-size: 14px;
  font-weight: 500;
  display: flex;
  align-items: center;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.chat-title strong {
  font-weight: 600;
  color: #0056d2;
}

.chat-title i.fa-thumbtack {
  font-size: 13px;
  color: #0078ff;
  opacity: 0.9;
}

/* ===== NÚT ⋮ MENU ===== */
.menu-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #666;
  padding: 2px 6px;
  border-radius: 50%;
  transition: background 0.2s;
}

.menu-btn:hover {
  background: rgba(0, 120, 255, 0.1);
}

/* ===== DROPDOWN MENU ===== */
.menu {
  display: none;
  position: absolute;
  right: 10px;
  top: 40px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  z-index: 20;
  min-width: 130px;
  overflow: hidden;
  animation: fadeIn 0.15s ease;
}

.menu button {
  display: block;
  width: 100%;
  border: none;
  background: none;
  padding: 10px 14px;
  text-align: left;
  font-size: 14px;
  color: #333;
  cursor: pointer;
  transition: all 0.2s ease;
}

.menu button:hover {
  background: #0078ff;
  color: #fff;
}

/* ===== CHAT GHIM ===== */
.chat-item.pinned {
  border-left: 4px solid #0078ff;
  background: #f0f6ff;
}

.chat-item.pinned:hover {
  background: #e3edff;
}

/* ===== HIỆU ỨNG MỞ MENU ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.chat-item {
  position: relative;
  z-index: 1;
}

.chat-item.open {
  z-index: 100; /* đưa item đang mở menu lên trên các item khác */
}

.menu {
  position: absolute;
  z-index: 9999; /* đảm bảo nổi lên trên cùng */
}
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden; /* tránh scroll toàn trang */
  background: #f8fafc; /* hoặc màu nền app */
}

/* Bao toàn bộ giao diện app (chat + sidebar) */
#app, .main-container {
  height: 100dvh; /* dùng đơn vị mới: dynamic viewport height */
  display: flex;
  flex-direction: row;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  height: 100%;
  overflow-y: auto;
}

/* Khung chat */
.chat-container {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.upload-btn {
  background: #f0f2f5;
  border-radius: 50%;
  padding: 8px;
  margin-right: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0078ff;
  transition: all 0.2s ease;
}

.upload-btn:hover {
  background: #e0e7ff;
  transform: scale(1.05);
}
#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.96);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#loginOverlay.hidden {
  display: none;
}
#loginOverlay h2 {
  color: #333;
  margin-bottom: 20px;
  font-size: 20px;
  text-align: center;
}

  </style>
</head>

<body>
  <!-- Overlay yêu cầu đăng nhập -->
<div id="loginOverlay" class="hidden">
  <h2>🔐 Vui lòng đăng nhập Google để sử dụng chatbot</h2>
  <div id="g_id_signin_overlay"></div>
</div>


  <div id="sidebarMenu" class="sidebar">
    <div class="search-box">
      <i style="color: black; padding:8px" class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="Tìm kiếm cuộc trò chuyện..." />
    </div>


    <!-- Nút tạo mới -->
    <button type="text" class="new-chat-btn" onclick="newChat()"><i style="padding-right: 6px;" class="fa-solid fa-pen-to-square"> </i> Cuộc trò chuyện mới</button>
    <span class="span">Gần đây</span>
  </div>
  <div class="chat-container">
    <!-- ===== SIDEBAR MENU ===== -->


    <!-- ===== HEADER ===== -->
    <div class="chat-header">
      <!-- Menu icon -->
      <div id="menuIcon" title="Tùy chọn" style="cursor: pointer; font-size: 22px;">☰</div>

      <!-- Tiêu đề -->
      <div style="flex: 1; text-align: center; text-transform: capitalize;">
        Hướng nghiệp & chọn ngành học
      </div>

      <!-- Avatar / Google login -->
      <div id="googleSection" style="cursor: pointer; position: relative;">
        <div id="g_id_signin" style="display: none;"></div>
        <img
          id="userAvatar"
          src="https://cdn-icons-png.flaticon.com/512/3001/3001764.png"
          alt="Đăng nhập"
          style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;"
          title="Đăng nhập Google"
        />
      </div>
      <button id="logoutBtn" onclick="logout()" style="display:none; background:none; border:none; color:white; cursor:pointer; font-weight:600;">
        Đăng xuất
      </button>
    </div>

    <!-- ===== CHAT BOX ===== -->
    <div class="chat-box" id="chat">
      <div class="msg bot">
        <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="AI" />
        <div class="bubble">
          Xin chào! 👋 Tôi là cố vấn hướng nghiệp AI. Hãy nói cho tôi biết sở thích hoặc điểm mạnh của bạn nhé!
        </div>
      </div>
    </div>

    <!-- ===== QUICK REPLIES ===== -->
    <div class="quick-reply">
      <button onclick="sendQuick('Tôi thích vẽ và sáng tạo nghệ thuật')">Nghệ thuật</button>
      <button onclick="sendQuick('Tôi giỏi Toán, Lý và thích kỹ thuật')">Kỹ thuật</button>
      <button onclick="sendQuick('Tôi thích chăm sóc và giúp đỡ người khác')">Y dược</button>
      <button onclick="sendQuick('Tôi thích giao tiếp và kinh doanh')">Kinh tế</button>
      <button onclick="sendQuick('Tôi thích giao tiếp và kinh doanh')">Công Nghệ</button>
    </div>

    
    <!-- ===== INPUT BOX ===== -->
    <div class="input-box">
      <!-- Nút tải file -->
  <label for="fileUpload" class="upload-btn" title="Tải tệp lên">
    <i class="fa-solid fa-paperclip"></i>
  </label>
  <input type="file" id="fileUpload" style="display:none" onchange="handleFile(event)" />

      <input id="input" type="text" placeholder="Nhập sở thích hoặc điểm mạnh của bạn..." onkeypress="handleKey(event)" />
      <button onclick="sendMsg()">Gửi</button>
    </div>
  </div>

  <!-- ===== SCRIPT AI CHAT ===== -->
  <script>
    const GEMINI_KEY = "AIzaSyC2HUulbDA-T05ahDvhm71zNZbY8oPPIPk";

async function askGemini(prompt) {
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `
Bạn là một AI thân thiện và am hiểu giáo dục Việt Nam, đóng vai trò cố vấn hướng nghiệp cho học sinh cấp 3.
Hãy trò chuyện ngắn gọn, thân thiện và trình bày **bố cục đẹp, dễ đọc**, có thể dùng emoji và xuống dòng hợp lý.
Luôn gợi ý 2–3 ngành học hoặc hướng đi phù hợp (nếu có liên quan), kèm mô tả ngắn gọn và gợi ý trường tiêu biểu nếu hợp lý.

Cấu trúc gợi ý (nếu phù hợp):
🎯 **Gợi ý ngành học phù hợp:**
1️⃣ [Tên ngành] — [Giải thích ngắn]
2️⃣ [Tên ngành] — [Giải thích ngắn]

🎓 **Trường gợi ý (nếu có):**
- [Tên trường]
- [Tên trường]

💬 **Mẹo nhỏ:** [Gợi ý hoặc lời khuyên tích cực]

Nếu người dùng hỏi ngoài chủ đề học tập, vẫn phản hồi tự nhiên, lịch sự và hữu ích, không gò bó theo mẫu.

Người dùng nói: ${prompt}
`



          }]
        }]
      })
    }
  );

  const data = await response.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || "⚠️ Không có phản hồi từ AI.";
}

// ✅ Kiểm tra xem người dùng có đang ở cuối khung chat không
function isUserAtBottom(chatBox) {
  return chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 50;
}

// ✅ Hiệu ứng gõ chữ — có kiểm tra cuộn
async function typeText(container, text, delay = 10) {
  container.innerHTML = "";
  let temp = "";
  const chatBox = document.getElementById("chat");

  for (let i = 0; i < text.length; i++) {
    temp += text.charAt(i);
    container.innerHTML = temp;

    // Chỉ cuộn nếu người dùng đang ở gần cuối
    if (isUserAtBottom(chatBox)) {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    await new Promise(r => setTimeout(r, delay));
  }

  // Sau khi gõ xong, hiển thị toàn bộ HTML thật
  container.innerHTML = text;

  // Nếu người dùng ở cuối thì mới tự cuộn đến cuối
  if (isUserAtBottom(chatBox)) {
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

// ✅ Gửi tin nhắn — tự cuộn thông minh
async function sendMsg(message = null) {
  const input = document.getElementById("input");
  const chat = document.getElementById("chat");
  const msg = message || input.value.trim();
  if (!msg) return;
  input.value = "";

  // Người dùng
  chat.innerHTML += `
    <div class='msg user'>
      <div class='bubble'>${msg}</div>
      <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="User" />
    </div>`;

  // Chỉ cuộn nếu người dùng đang ở cuối
  if (isUserAtBottom(chat)) {
    chat.scrollTop = chat.scrollHeight;
  }

  // Bot đang suy nghĩ
  const botMsg = document.createElement("div");
  botMsg.className = "msg bot";
  botMsg.innerHTML = `
    <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="AI" />
    <div class="bubble typing-bubble">Vui lòng chờ trong giây lát<span class="typing-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
    </div>`;
  chat.appendChild(botMsg);

  // Cuộn chỉ khi ở cuối
  if (isUserAtBottom(chat)) {
    chat.scrollTop = chat.scrollHeight;
  }

  const bubble = botMsg.querySelector(".bubble");

  try {
    const reply = await askGemini(msg);
    await new Promise(r => setTimeout(r, 400));

    const cleanReply = reply
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
      .replace(/\n/g, "<br>");

    await typeText(bubble, cleanReply, 18);
  } catch (e) {
    bubble.innerHTML = `⚠️ Lỗi: ${e.message}`;
  }

  // Sau khi gõ xong, nếu người dùng vẫn ở cuối, cuộn xuống
  if (isUserAtBottom(chat)) {
    chat.scrollTop = chat.scrollHeight;
  }
}

    function sendQuick(text) {
      document.getElementById("input").value = text;
      sendMsg(text);
    }
    function handleKey(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    }
    function isUserAtBottom(chatBox) {
      return chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 50;
    }

  </script>

  <!-- ===== GOOGLE LOGIN ===== -->
 <!-- Google Sign-in -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  let userData = JSON.parse(localStorage.getItem("userData") || "null");

  window.onload = function () {
    google.accounts.id.initialize({
      client_id: "651931498757-b81tibe02fm08puv5tacju8qs97dnqrt.apps.googleusercontent.com",
      callback: handleCredentialResponse,
      auto_select: true // ✅ Cho phép Google tự chọn tài khoản đã đăng nhập trước đó
    });

    // Nếu chưa đăng nhập thì hiển thị overlay
    if (!userData) {
      showLoginOverlay();
    } else {
      applyUserData(userData);
    }
  };

  // ✅ Hàm hiển thị overlay đăng nhập
  function showLoginOverlay() {
    const overlay = document.getElementById("loginOverlay");
    overlay.classList.remove("hidden");

    google.accounts.id.renderButton(
      document.getElementById("g_id_signin_overlay"),
      { theme: "filled_blue", size: "large", text: "signin_with" }
    );
  }

  // ✅ Khi Google trả về token
  function handleCredentialResponse(response) {
    const data = parseJwt(response.credential);
    userData = data;
    localStorage.setItem("userData", JSON.stringify(data)); // Lưu để nhớ lần sau
    applyUserData(data);
  }

  // ✅ Áp dụng dữ liệu người dùng vào giao diện
  function applyUserData(data) {
    document.getElementById("loginOverlay").classList.add("hidden");

    const avatar = document.getElementById("userAvatar");
    avatar.src = data.picture || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    avatar.title = `${data.name} (${data.email})`;

    // Gửi lời chào trong khung chat (nếu chưa gửi)
    const chat = document.getElementById("chat");
    if (!chat.dataset.greeted) {
      chat.dataset.greeted = "true";
      chat.innerHTML += `
        <div class='msg bot'>
          <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" />
          <div class='bubble'>Xin chào <b>${data.given_name || data.name}</b> 👋! Rất vui được đồng hành cùng bạn!</div>
        </div>`;
    }

    // Hiện nút đăng xuất
    document.getElementById("logoutBtn").style.display = "block";
  }

  // ✅ Đăng xuất
  function logout() {
    google.accounts.id.disableAutoSelect();
    localStorage.removeItem("userData");
    location.reload();
  }

  // ✅ Giải mã JWT (token từ Google)
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
      '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join(''));
    return JSON.parse(jsonPayload);
  }
</script>


  <script>
  const menuIcon = document.getElementById("menuIcon");
  const sidebar = document.getElementById("sidebarMenu");
  const chatContainer = document.querySelector(".chat-container");

  // Khi nhấn vào ☰
  menuIcon.addEventListener("click", () => {
    const isActive = sidebar.classList.toggle("active");
    chatContainer.classList.toggle("shifted", isActive);
  });

  // Khi nhấn ra ngoài thì đóng
  document.addEventListener("click", (e) => {
    if (!sidebar.contains(e.target) && !menuIcon.contains(e.target)) {
      sidebar.classList.remove("active");
      chatContainer.classList.remove("shifted");
    }
  });
</script>

<script>
let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
let currentChat = null;

function renderChatList() {
  const sidebar = document.getElementById("sidebarMenu");
  let list = document.getElementById("chatList");
  if (!list) {
    list = document.createElement("div");
    list.id = "chatList";
    sidebar.appendChild(list);
  }

  list.innerHTML = chatHistory
    .map((c, i) => `
      <div class="chat-item ${c.pinned ? 'pinned' : ''}">
        <span class="chat-title" onclick="loadChat(${i})">
          ${c.pinned ? '<i class="fa-solid fa-thumbtack" style="color:#0078ff; margin-right:6px;"></i>' : ''}
          ${c.pinned ? `<strong>${c.name}</strong>` : c.name}
        </span>
        <div class="dropdown">
          <button class="menu-btn" onclick="toggleMenu(${i})">⋮</button>
          <div class="menu" id="menu-${i}">
            <button onclick="renameChat(${i})">Đổi tên</button>
            <button onclick="pinChat(${i})">${c.pinned ? 'Bỏ ghim' : 'Ghim'}</button>
            <button onclick="shareChat(${i})">Chia sẻ</button>
            <button onclick="deleteChat(${i})">Xóa</button>
          </div>
        </div>
      </div>
    `)
    .join("");
}

function saveCurrentChat() {
  const chatBox = document.getElementById("chat");
  if (!chatBox || chatBox.innerHTML.trim() === "") return;

  const content = chatBox.innerHTML;
  if (currentChat !== null) {
    chatHistory[currentChat].content = content;
  } else {
    const firstMsg = chatBox.querySelector(".msg.user .bubble")?.innerText || "Cuộc trò chuyện mới";
    chatHistory.unshift({ name: firstMsg.substring(0, 30), content, pinned: false });
    currentChat = 0;
  }

  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
  renderChatList();
}

function newChat() {
  saveCurrentChat();

  const chatBox = document.getElementById("chat");
  chatBox.innerHTML = `
    <div class="msg bot">
      <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="AI" />
      <div class="bubble">Xin chào 👋 Tôi là cố vấn hướng nghiệp AI. Hãy nói cho tôi biết sở thích hoặc điểm mạnh của bạn nhé!</div>
    </div>`;
  currentChat = null;
}

function loadChat(index) {
  const chatBox = document.getElementById("chat");
  chatBox.innerHTML = chatHistory[index].content;
  currentChat = index;
}

function deleteChat(index) {
  chatHistory.splice(index, 1);
  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
  renderChatList();
}

function renameChat(index) {
  const newName = prompt("Nhập tên mới:", chatHistory[index].name);
  if (newName) {
    chatHistory[index].name = newName;
    localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    renderChatList();
  }
}

function pinChat(index) {
  const chat = chatHistory[index];
  chat.pinned = !chat.pinned; // Đổi trạng thái ghim

  // Đưa ghim lên đầu, bỏ ghim thì giữ nguyên vị trí hiện tại
  if (chat.pinned) {
    chatHistory.splice(index, 1);
    chatHistory.unshift(chat);
  }

  localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
  renderChatList();
}

function shareChat(index) {
  const text = chatHistory[index].content
    .replace(/<[^>]+>/g, "") // bỏ thẻ HTML
    .slice(0, 1000); // tránh quá dài
  const encoded = encodeURIComponent(text);

  // Mở cửa sổ chia sẻ Zalo
  window.open(`https://zalo.me/share/text?text=${encoded}`, "_blank");
}


function toggleMenu(i) {
  const currentMenu = document.getElementById(`menu-${i}`);
  const isOpen = currentMenu.style.display === "block";

  // Đóng tất cả menu khác
  document.querySelectorAll(".menu").forEach(m => (m.style.display = "none"));
  document.querySelectorAll(".chat-item").forEach(it => it.classList.remove("open"));

  // Nếu menu đang tắt thì mở và thêm class open
  if (!isOpen) {
    currentMenu.style.display = "block";
    currentMenu.closest(".chat-item").classList.add("open");
  }
}



renderChatList();
// Khi nhấn vào sidebar thì đóng tất cả menu ⋮ đang mở
document.getElementById("sidebarMenu").addEventListener("click", (e) => {
  // Nếu click KHÔNG nằm trong nút ⋮ hoặc menu thì đóng tất cả menu
  if (!e.target.closest(".menu-btn") && !e.target.closest(".menu")) {
    document.querySelectorAll(".menu").forEach(m => (m.style.display = "none"));
    document.querySelectorAll(".chat-item").forEach(it => it.classList.remove("open"));
  }
});
</script>


</body>
</html>
